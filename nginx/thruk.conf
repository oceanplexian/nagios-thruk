# Server block for localhost internal auth requests
server {
    listen 127.0.0.1:80 default_server;
    server_name localhost;
    
    location = /thruk/cgi-bin/restricted.cgi {
        auth_basic "Thruk Authentication";
        auth_basic_user_file /etc/thruk/htpasswd;
        
        # Add header outside if block to ensure it's always sent
        add_header WWW-Authenticate 'Basic realm="Thruk Authentication"' always;

        if ($remote_user = "") {
            return 401;
        }
        return 200 "OK: $remote_user\n";
    }
}

server {
    listen 80;
    server_name _; # Listen on all hostnames

    # Logs to stdout/stderr
    access_log /dev/stdout;
    error_log /dev/stderr warn;

    # Redirect root requests to the main Thruk page, preserving host/port
    location = / {
        return 302 $scheme://$http_host/thruk/;
    }

    # Thruk static themes, styles and javascripts
    # Point alias directly to themes-available as themes-enabled doesn't exist
    location /thruk/themes/ {
        alias /usr/share/thruk/themes/themes-available/; # Point to where themes actually are
        # Try static file, if not found, it's a 404 (no fallback needed)
        try_files $uri $uri/ =404;
    }

    # Authentication endpoint - must match internal endpoint exactly
    location = /thruk/cgi-bin/restricted.cgi {
        auth_basic "Thruk Authentication";
        auth_basic_user_file /etc/thruk/htpasswd;

        # Add header outside if block to ensure it's always sent
        add_header WWW-Authenticate 'Basic realm="Thruk Authentication"' always;

        if ($remote_user = "") {
            return 401;
        }
        return 200 "OK: $remote_user\n";
    }

    # Handle ALL locations under /thruk/
    location /thruk/ {
        # Point to the base directory where Thruk assets actually live
        alias /usr/share/thruk/root/thruk/;

        # Try to serve the static file directly.
        # If not found, pass request to the uWSGI backend via named location.
        try_files $uri @uwsgi_fallback;
    }

    # Named location for uWSGI fallback
    # Handles all non-static requests under /thruk/
    location @uwsgi_fallback {
        include uwsgi_params;
        uwsgi_pass unix:/var/run/thruk/uwsgi.socket;
        uwsgi_modifier1 5;
    }

    # Specific location block for /thruk/r/ removed - handled by fallback
    # Specific location block for /thruk/cgi-bin/ removed - handled by fallback
} 